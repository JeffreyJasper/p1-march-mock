<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jeremy æ•¸å­¸åµæ¢ V7.0 - ç©¶æ¥µå®Œå…¨ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.95); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- SVG åœ–æ¨™ ---
        const Icon = {
            Search: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trophy: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            CheckCircle2: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            AlertCircle: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            RefreshCcw: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><polyline points="21 3 21 8 16 8"/></svg>,
            ChevronRight: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Clock: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            MoveRight: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8L22 12L18 16"/><path d="M2 12H22"/></svg>
        };

        // --- é¡Œç›®é¡å‹å®šç¾© (æ•´åˆèˆŠç‰ˆ + æ–°éŒ¯èª¤é‡å°ç‰ˆ) ---
        const QUESTION_TYPES = {
            // åŸæœ‰é¡Œå‹
            COMPARISON: 'æ¯”è¼ƒé‚è¼¯',
            FILTERING: 'è³‡è¨Šç¯©é¸',
            VERTICAL_FILL: 'ç›´å¼å¡«æ ¼',
            TIME_APP: 'æ™‚é˜æ‡‰ç”¨',
            TIME_DRAW: 'äº’å‹•æ’¥é˜',
            // æ–°å¢é¡Œå‹ (é‡å° Jeremy éŒ¯èª¤)
            HORIZONTAL: 'æ©«å¼é™·é˜±',      
            CARD_SORT: 'æ•¸å­—å¡ç‰‡',       
            HIDDEN_EACH: 'ã€Œå„ã€å­—æ‡‰ç”¨',   
            PRICE_LOGIC: 'åƒ¹éŒ¢æ¨ç†',     
            TIME_FUZZY: 'æ™‚é–“æè¿°'       
        };

        const CATEGORIES = {
            CANDY: ['è»Ÿç³–', 'ç‰›å¥¶ç³–', 'æ‹–è‚¥ç³–', 'æ°´æœç³–', 'æ£’æ£’ç³–'],
            FRUIT: ['è˜‹æœ', 'æ©™', 'è¥¿ç“œ', 'é›ªæ¢¨', 'é¦™è•‰'],
            CLOTHING: ['é•·è¢–è¡«', 'çŸ­è¢–è¡«', 'é•·è¤²', 'çŸ­è¤²', 'å¤–å¥—']
        };

        const TOTAL_QUESTIONS = 20; // å¢åŠ é¡Œæ•¸ä»¥å®¹ç´æ–°é¡Œå‹

        // --- å­çµ„ä»¶ï¼šç›´å¼æ’ç‰ˆ (åŸæœ‰) ---
        const VerticalDisplay = ({ data, subStep, selectedAnswer }) => (
            <div className="flex justify-center my-8 font-mono scale-110">
                <div className="grid grid-cols-[3rem_4rem_4rem] items-center text-5xl leading-none text-slate-700">
                    <div className="col-start-1"></div>
                    <div className="col-start-2 text-center">{data.t1}</div>
                    <div className={`col-start-3 text-center border-2 border-dashed rounded-xl h-20 flex items-center justify-center transition-all ${subStep === 'first' && !selectedAnswer ? 'border-amber-400 bg-amber-50 animate-pulse text-amber-600' : 'border-slate-200 bg-white text-slate-700'}`}>
                        {subStep === 'first' && !selectedAnswer ? 'a' : data.o1}
                    </div>
                    <div className="col-start-1 text-center text-slate-400 font-bold">{data.symbol}</div>
                    <div className={`col-start-2 text-center border-2 border-dashed rounded-xl h-20 flex items-center justify-center transition-all ${subStep === 'second' && !selectedAnswer ? 'border-indigo-400 bg-indigo-50 animate-pulse text-indigo-600' : (subStep === 'first' ? 'border-slate-100 bg-slate-50 text-transparent' : 'border-slate-200 bg-white text-slate-700')}`}>
                        {subStep === 'second' && !selectedAnswer ? 'b' : (subStep === 'first' ? '?' : data.t2)}
                    </div>
                    <div className="col-start-3 text-center">{data.o2}</div>
                    <div className="col-span-3 border-b-8 border-slate-800 my-6 rounded-full"></div>
                    <div className="col-start-1"></div>
                    <div className="col-start-2 text-center font-black text-slate-900">{Math.floor(data.result / 10)}</div>
                    <div className="col-start-3 text-center font-black text-slate-900">{data.result % 10}</div>
                </div>
            </div>
        );

        // --- å­çµ„ä»¶ï¼šæ™‚é˜ (é€šç”¨) ---
        const ClockFace = ({ h, m, color = "#1e293b" }) => {
            const hourAngle = (h * 30) + (m * 0.5);
            const minuteAngle = m * 6;
            return (
                <div className="flex justify-center my-6">
                    <svg width="180" height="180" viewBox="0 0 200 200" className="drop-shadow-2xl">
                        <circle cx="100" cy="100" r="95" fill="white" stroke={color} strokeWidth="5" />
                        {[...Array(12)].map((_, i) => (
                            <text key={i} x={100 + 72 * Math.sin((i+1)*Math.PI/6)} y={105 - 72 * Math.cos((i+1)*Math.PI/6)} textAnchor="middle" className="font-black text-xl" fill={color}>{i+1}</text>
                        ))}
                        <line x1="100" y1="100" x2={100 + 40 * Math.sin(hourAngle * Math.PI / 180)} y2={100 - 40 * Math.cos(hourAngle * Math.PI / 180)} stroke={color} strokeWidth="10" strokeLinecap="round" />
                        <line x1="100" y1="100" x2={100 + 70 * Math.sin(minuteAngle * Math.PI / 180)} y2={100 - 70 * Math.cos(minuteAngle * Math.PI / 180)} stroke="#ef4444" strokeWidth="6" strokeLinecap="round" />
                        <circle cx="100" cy="100" r="7" fill={color} />
                    </svg>
                </div>
            );
        };

        // --- ä¸»æ‡‰ç”¨ç¨‹å¼ ---
        const App = () => {
            const [currentStep, setCurrentStep] = useState('menu'); 
            const [score, setScore] = useState(0);
            const [questionCount, setQuestionCount] = useState(0);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [subStep, setSubStep] = useState('first'); 
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [showRationale, setShowRationale] = useState(false);
            const [history, setHistory] = useState([]);
            const [startTime, setStartTime] = useState(null);
            const [totalTime, setTotalTime] = useState(0);
            const [tempIsFirstCorrect, setTempIsFirstCorrect] = useState(null);
            const [questionSequence, setQuestionSequence] = useState([]);
            const [drawHour, setDrawHour] = useState(12);
            const [drawMinute, setDrawMinute] = useState(0);

            const shuffle = (array) => [...array].sort(() => Math.random() - 0.5);

            const initSequence = () => {
                const types = Object.values(QUESTION_TYPES);
                let seq = [];
                // æ¯å€‹é¡å‹å‡º 2 é¡Œï¼Œå…± 20 é¡Œ
                types.forEach(type => { seq.push(type, type); });
                return shuffle(seq);
            };

            const generateQuestion = (index, sequence) => {
                const type = sequence[index];
                const names = shuffle(['å°æ˜', 'å­è¨€', 'å°ç²', 'å®¶å˜‰', 'å­è³¢', 'å°ä¸']);
                let q = { type, id: Date.now() };

                // é è¨­ç‚ºä¸€æ­¥å®Œæˆï¼Œç‰¹æ®Šé¡Œå‹å†æ”¹ç‚º 'first'
                setSubStep('second'); 

                switch (type) {
                    // --- åŸæœ‰é¡Œå‹ ---
                    case QUESTION_TYPES.COMPARISON: {
                        const cat = Object.values(CATEGORIES)[Math.floor(Math.random() * 2)];
                        const item = cat[Math.floor(Math.random() * cat.length)];
                        const val1 = Math.floor(Math.random() * 15) + 10;
                        const diff = Math.floor(Math.random() * 8) + 2;
                        const isReverse = Math.random() < 0.8;
                        const more = Math.random() > 0.5;
                        let sign = isReverse ? (more ? '-' : '+') : (more ? '+' : '-');
                        q.correctFirst = `${val1} ${sign} ${diff}`;
                        q.correctSecond = sign === '+' ? val1 + diff : val1 - diff;
                        q.text = isReverse 
                            ? `${names[0]}æœ‰${item}${val1}å€‹ï¼Œ${names[0]}çš„${item}æ¯”${names[1]}çš„${item}${more ? 'å¤š' : 'å°‘'}${diff}å€‹ã€‚è«‹å•${names[1]}æœ‰å¤šå°‘å€‹${item}ï¼Ÿ`
                            : `${names[0]}æœ‰${item}${val1}å€‹ï¼Œ${names[1]}çš„${item}æ¯”${names[0]}çš„${item}${more ? 'å¤š' : 'å°‘'}${diff}å€‹ã€‚è«‹å•${names[1]}æœ‰å¤šå°‘å€‹${item}ï¼Ÿ`;
                        q.firstOptions = shuffle([`${val1} + ${diff}`, `${val1} - ${diff}`]);
                        const opts = new Set([q.correctSecond.toString()]);
                        while(opts.size < 4) opts.add((q.correctSecond + Math.floor(Math.random() * 8) - 4).toString());
                        q.secondOptions = shuffle(Array.from(opts));
                        q.explanationFirst = sign === '+' ? "æ‰¾çš„äººæ˜¯ã€Œå¤§å“¥å“¥ã€ï¼Œè¦ç”¨åŠ æ³•ã€‚" : "æ‰¾çš„äººæ˜¯ã€Œå°å¼Ÿå¼Ÿã€ï¼Œè¦ç”¨æ¸›æ³•ã€‚";
                        q.explanationSecond = `æ­£ç¢ºç®—å¼ï¼š${q.correctFirst} = ${q.correctSecond}ã€‚`;
                        setSubStep('first');
                        break;
                    }
                    case QUESTION_TYPES.VERTICAL_FILL: {
                        const isAddition = Math.random() > 0.5;
                        let t1, o1, t2, o2, result, symbol, isSpecial;
                        if (isAddition) {
                            symbol = '+';
                            o1 = Math.floor(Math.random() * 7) + 3; o2 = Math.floor(Math.random() * 9) + 1;
                            while (o1 + o2 < 10) o2++; isSpecial = "é€²ä½";
                            t1 = Math.floor(Math.random() * 3) + 1; t2 = Math.floor(Math.random() * 3) + 1;
                            result = (t1 * 10 + o1) + (t2 * 10 + o2);
                        } else {
                            symbol = '-';
                            t1 = Math.floor(Math.random() * 5) + 4; t2 = Math.floor(Math.random() * 3) + 1;
                            o1 = Math.floor(Math.random() * 5); o2 = Math.floor(Math.random() * 4) + 6; isSpecial = "é€€ä½";
                            result = (t1 * 10 + o1) - (t2 * 10 + o2);
                        }
                        q.vertical = { t1, o1, t2, o2, result, symbol };
                        q.text = `æŒ‘æˆ°ã€Œ${isSpecial}${symbol === '+' ? 'åŠ æ³•' : 'æ¸›æ³•'}ã€åµæ¢è¬é¡Œï¼Œæ‰¾å‡º [a] å’Œ [b]ã€‚`;
                        q.correctFirst = o1.toString();
                        q.correctSecond = t2.toString();
                        const gen = (c) => {
                            const s = new Set([c]);
                            while(s.size < 4) s.add(Math.floor(Math.random() * 10).toString());
                            return shuffle(Array.from(s));
                        };
                        q.firstOptions = gen(q.correctFirst);
                        q.secondOptions = gen(q.correctSecond);
                        q.explanationFirst = symbol === '+' ? `å€‹ä½éƒ¨åˆ†ï¼š${o1} + ${o2} = ${o1 + o2}ã€‚` : `å€‹ä½éƒ¨åˆ†ï¼š${o1} æ¸› ${o2} éœ€è¦å€Ÿä½å—ï¼Ÿ`;
                        q.explanationSecond = `åä½éƒ¨åˆ†ï¼šè¦è¨˜å¾—è™•ç†å‰›æ‰çš„${isSpecial === 'é€²ä½' ? 'é€²ä½' : isSpecial === 'é€€ä½' ? 'å€Ÿä½' : 'ä½å€¼'}ã€‚`;
                        setSubStep('first');
                        break;
                    }
                    case QUESTION_TYPES.TIME_APP: {
                        const startH = Math.floor(Math.random() * 4) + 7;
                        const duration = Math.floor(Math.random() * 3) + 2;
                        const finishH = startH + duration;
                        const busH = finishH + (Math.random() > 0.5 ? 1 : -1);
                        const canCatch = busH >= finishH;
                        q.startH = startH; q.duration = duration;
                        q.busH = busH > 12 ? busH - 12 : busH; q.busM = 0;
                        q.correctSecond = canCatch ? "å¯ä»¥" : "ä¸å¯ä»¥";
                        q.text = `${names[0]}åœ¨ä¸Šåˆ ${startH} æ™‚è¿”å­¸ï¼Œ${duration} å°æ™‚å¾Œæ”¾å­¸ã€‚è«‹å•æ”¾å­¸å¾Œèƒ½å¦ä¹˜æ­é€™ç­å·´å£«ï¼Ÿ`;
                        q.secondOptions = ["å¯ä»¥", "ä¸å¯ä»¥"];
                        q.explanationSecond = `æ”¾å­¸æ™‚é–“æ˜¯ ${finishH > 12 ? finishH - 12 : finishH} æ™‚ï¼Œå·´å£«åœ¨ ${q.busH} æ™‚é–‹å‡ºã€‚`;
                        break;
                    }
                    case QUESTION_TYPES.TIME_DRAW: {
                        const h = Math.floor(Math.random() * 12) + 1;
                        const isHalf = Math.random() > 0.5;
                        q.targetH = h; q.targetM = isHalf ? 30 : 0;
                        q.text = `åµæ¢ä»»å‹™ï¼šè«‹èª¿æ•´ä¸‹æ–¹æ™‚é˜ï¼Œç•«å‡ºã€Œ${h} æ™‚${isHalf ? 'åŠ' : 'æ­£'}ã€ã€‚`;
                        q.explanationSecond = `æ¼‚äº®ï¼é•·é‡èˆ‡çŸ­é‡ä½ç½®æ­£ç¢ºã€‚`;
                        setDrawHour(12); setDrawMinute(0);
                        break;
                    }
                    case QUESTION_TYPES.FILTERING: {
                        const catKeys = Object.keys(CATEGORIES);
                        const targetKey = catKeys[Math.floor(Math.random() * catKeys.length)];
                        const otherKey = catKeys.find(k => k !== targetKey);
                        const tItems = shuffle(CATEGORIES[targetKey]);
                        const oItems = shuffle(CATEGORIES[otherKey]);
                        const v1 = Math.floor(Math.random() * 15) + 15;
                        const v2 = Math.floor(Math.random() * 15) + 15;
                        const vD = Math.floor(Math.random() * 30) + 20;
                        const info = shuffle([{ t: `${tItems[0]}${v1}å€‹`, v: v1 }, { t: `${oItems[0]}${vD}å€‹`, v: vD }, { t: `${tItems[1]}${v2}å€‹`, v: v2 }]);
                        const catN = targetKey === 'CANDY' ? 'ç³–æœ' : targetKey === 'FRUIT' ? 'æ°´æœ' : 'è¡£æœ';
                        q.text = `æ¡Œä¸Šæœ‰ï¼š${info[0].t}ã€${info[1].t}å’Œ${info[2].t}ã€‚è«‹å•ã€Œ${catN}ã€å…±æœ‰å¤šå°‘å€‹ï¼Ÿ`;
                        q.correctSecond = v1 + v2;
                        q.explanationSecond = `åµæ¢æç¤ºï¼šéæ¿¾æ‰å¹²æ“¾é …ã€‚ç®—å¼ï¼š${v1} + ${v2} = ${v1 + v2}ã€‚`;
                        const opts = new Set([q.correctSecond.toString()]);
                        while(opts.size < 4) opts.add((q.correctSecond + Math.floor(Math.random() * 20) - 10).toString());
                        q.secondOptions = shuffle(Array.from(opts));
                        break;
                    }

                    // --- æ–°å¢é¡Œå‹ (é‡å° Jeremy éŒ¯èª¤) ---
                    case QUESTION_TYPES.HORIZONTAL: {
                        const t1 = Math.floor(Math.random() * 4) + 5; 
                        const o1 = Math.floor(Math.random() * 8) + 1; 
                        const t2 = Math.floor(Math.random() * 2) + 1; 
                        const o2 = Math.floor(Math.random() * o1); 
                        const num1 = t1 * 10 + o1;
                        const num2 = t2 * 10 + o2;
                        q.correctSecond = num1 - num2;
                        q.text = `ã€æ©«å¼ç‰¹è¨“ã€‘ç´°å¿ƒè¨ˆç®—ï¼š ${num1} - ${num2} = ?`;
                        q.explanationSecond = `å…ˆç®—å€‹ä½ï¼š${o1}-${o2}=${o1-o2}ï¼Œå†ç®—åä½ï¼š${t1}0-${t2}0=${t1-t2}0ã€‚ä¸è¦å°éŒ¯ä½ï¼`;
                        q.secondOptions = shuffle([q.correctSecond, q.correctSecond - 10, q.correctSecond + 2, (t1-t2)*10 + (o1+o2)]);
                        break;
                    }
                    case QUESTION_TYPES.CARD_SORT: {
                        const subType = Math.random() > 0.5 ? 'largest_odd' : 'smallest_even';
                        if (subType === 'largest_odd') {
                            const cards = shuffle(['87', '21', 'ä¸ƒ', '52', 'å››', 'ä¸€']);
                            q.text = `å¾ ${cards.join('ï¼Œ')} ä¸­ï¼Œé¸å‡ºæœ€å¤§çš„ã€Œå…©ä½å–®æ•¸ã€ã€‚`;
                            q.correctSecond = 87;
                            q.secondOptions = shuffle([87, 21, 52, 7]);
                            q.explanationSecond = `ã€Œä¸ƒã€åªæ˜¯ä¸€ä½æ•¸ï¼Œã€Œ52ã€æ˜¯é›™æ•¸ã€‚æœ€å¤§çš„ã€Œå…©ä½å–®æ•¸ã€æ˜¯ 87ã€‚`;
                        } else {
                            const digits = shuffle([1, 4, 7]);
                            q.text = `ç”¨ ${digits.map(d=>['ä¸€','å››','ä¸ƒ'][d===1?0:d===4?1:2]).join('ï¼Œ')} ä¸‰å¼µå¡ï¼Œçµ„æˆã€Œæœ€å°ã€çš„ã€Œå…©ä½é›™æ•¸ã€ã€‚`;
                            q.correctSecond = 14;
                            q.secondOptions = shuffle([14, 17, 41, 74]);
                            q.explanationSecond = `è¦é›™æ•¸ï¼Œå€‹ä½å¿…é ˆæ˜¯ã€Œå››ã€(4)ã€‚14 æ¯” 74 å°ã€‚`;
                        }
                        break;
                    }
                    case QUESTION_TYPES.HIDDEN_EACH: {
                        const item = Math.random() > 0.5 ? 'ä¸‰æ–‡æ²»' : 'ç³–æœ';
                        const n1 = Math.floor(Math.random() * 3) + 3;
                        const left = Math.floor(Math.random() * 10) + 20;
                        q.text = `${names[0]}å’Œ${names[1]}ã€Œå„ã€åƒäº† ${n1} ä»¶${item}ï¼Œé‚„å‰©ä¸‹ ${left} ä»¶ã€‚åŸæœ‰${item}å¤šå°‘ä»¶ï¼Ÿ`;
                        q.correctSecond = left + n1 + n1;
                        q.secondOptions = shuffle([q.correctSecond, left + n1, left - n1, q.correctSecond + 10]);
                        q.explanationSecond = `é—œéµæ˜¯ã€Œå„ã€ï¼å…©äººå…±åƒäº† ${n1}+${n1} ä»¶ã€‚ç®—å¼ï¼š${left} + ${n1} + ${n1} = ${q.correctSecond}ã€‚`;
                        break;
                    }
                    case QUESTION_TYPES.PRICE_LOGIC: {
                        const priceA = Math.floor(Math.random() * 20) + 30;
                        const diff = Math.floor(Math.random() * 10) + 15;
                        const isExpensive = Math.random() > 0.5;
                        q.text = `æ‰‹å¥—å”® $${priceA}ï¼Œåœå·¾æ¯”æ‰‹å¥—ã€Œ${isExpensive?'è²´':'ä¾¿å®œ'}ã€$${diff}ã€‚åœå·¾å”®å¤šå°‘å…ƒï¼Ÿ`;
                        q.correctSecond = isExpensive ? priceA + diff : priceA - diff;
                        q.secondOptions = shuffle([priceA + diff, priceA - diff, diff, priceA + diff + 10]);
                        q.explanationSecond = isExpensive ? `ã€Œè²´ã€å³æ˜¯å¤šï¼Œ$${priceA} + $${diff}ã€‚` : `ã€Œä¾¿å®œã€å³æ˜¯å°‘ï¼Œ$${priceA} - $${diff}ã€‚`;
                        break;
                    }
                    case QUESTION_TYPES.TIME_FUZZY: {
                        const h = Math.floor(Math.random() * 12) + 1;
                        const scenario = Math.random();
                        let showM, ansText;
                        if (scenario < 0.4) { showM = 35; ansText = `${h} æ™‚åŠå¤šäº›`; }
                        else if (scenario < 0.7) { showM = 30; ansText = `${h} æ™‚åŠ`; }
                        else { showM = 5; ansText = `${h} æ™‚å¤šäº›`; }
                        
                        q.text = `åœ–ä¸­æ™‚é˜é¡¯ç¤ºçš„æ™‚é–“æ˜¯ï¼Ÿ`;
                        q.fuzzyTime = { h, m: showM }; // å‚³éçµ¦ ClockFace
                        q.correctSecond = ansText;
                        q.secondOptions = shuffle([`${h} æ™‚åŠ`, `${h} æ™‚åŠå¤šäº›`, `${h} æ™‚å¤šäº›`, `${h+1} æ™‚æ­£`]);
                        q.explanationSecond = `åˆ†é‡æŒ‡è‘— ${showM} åˆ†ï¼Œ${scenario < 0.4 ? 'éäº† 6 å­—ï¼Œæ‰€ä»¥æ˜¯ã€ŒåŠå¤šäº›ã€' : scenario < 0.7 ? 'æ­£æ­£æŒ‡è‘— 6ï¼Œæ˜¯ã€ŒåŠã€' : 'å‰›é 12 å­—ï¼Œæ˜¯ã€Œå¤šäº›ã€'}ã€‚`;
                        break;
                    }
                    default: break;
                }
                setCurrentQuestion(q);
                setSelectedAnswer(null); setIsCorrect(null); setShowRationale(false); setTempIsFirstCorrect(null);
            };

            const startQuiz = () => {
                const seq = initSequence();
                setQuestionSequence(seq);
                setScore(0); setQuestionCount(0); setHistory([]); setStartTime(Date.now());
                generateQuestion(0, seq);
                setCurrentStep('quiz');
            };

            const handleAnswer = (ans) => {
                if (selectedAnswer !== null && subStep === 'second') return;
                
                // è™•ç†å…©æ­¥å¼é¡Œç›® (åŸæœ‰çš„æ¯”è¼ƒé¡Œ & ç›´å¼é¡Œ)
                if (subStep === 'first') {
                    const ok = ans === currentQuestion.correctFirst;
                    setTempIsFirstCorrect(ok); setSelectedAnswer(ans);
                    if (ok) { setTimeout(() => { setSubStep('second'); setSelectedAnswer(null); }, 600); }
                    else { finish(ans, false); }
                } 
                // è™•ç†æ‰€æœ‰é¡Œç›®çš„æœ€çµ‚ç­”æ¡ˆ
                else {
                    if (currentQuestion.type === QUESTION_TYPES.TIME_DRAW) {
                        const ok = drawHour === currentQuestion.targetH && drawMinute === currentQuestion.targetM;
                        finish(`${drawHour}:${drawMinute}`, ok);
                    } else {
                        const ok = ans.toString() === currentQuestion.correctSecond.toString();
                        finish(ans, ok && (currentQuestion.correctFirst ? tempIsFirstCorrect : true));
                    }
                }
            };

            const finish = (ans, ok) => {
                setSelectedAnswer(ans); setIsCorrect(ok);
                if (ok) setScore(s => s + 1);
                setHistory(p => [...p, { ...currentQuestion, userAns: ans, isOk: ok, firstOk: tempIsFirstCorrect }]);
                setShowRationale(true);
            };

            const nextQuestion = () => {
                if (questionCount >= TOTAL_QUESTIONS - 1) {
                    setTotalTime(Math.floor((Date.now() - startTime) / 1000));
                    setCurrentStep('feedback');
                } else {
                    const nextIdx = questionCount + 1;
                    setQuestionCount(nextIdx);
                    generateQuestion(nextIdx, questionSequence);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="mx-auto max-w-2xl">
                        <header className="mb-6 flex items-center justify-between rounded-[2rem] bg-white p-6 shadow-sm border border-slate-200">
                            <div className="flex items-center gap-4">
                                <div className="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg shadow-indigo-100"><Icon.Search size={24} /></div>
                                <div>
                                    <h1 className="text-2xl font-black text-slate-800 leading-none">æ•¸å­¸åµæ¢ V7.0</h1>
                                    <p className="text-xs font-bold text-slate-400 mt-1 uppercase">Jeremy ç©¶æ¥µå®Œå…¨ç‰ˆ</p>
                                </div>
                            </div>
                            {currentStep === 'quiz' && (
                                <span className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-2xl text-lg font-black border border-indigo-100">
                                    {questionCount + 1} / {TOTAL_QUESTIONS}
                                </span>
                            )}
                        </header>

                        {currentStep === 'menu' && (
                            <div className="rounded-[3rem] bg-white p-12 text-center shadow-xl border border-slate-100">
                                <Icon.Trophy className="h-24 w-24 text-amber-400 mx-auto mb-8 animate-bounce" />
                                <h2 className="mb-4 text-3xl font-black text-slate-800">å…¨èƒ½æ•¸å­¸ç‰¹è¨“</h2>
                                <p className="text-slate-500 font-bold mb-10 leading-relaxed text-lg">
                                    ğŸ•µï¸â€â™‚ï¸ 20 é¡Œç¶œåˆæ¡ˆä»¶<br/>
                                    åŒ…å«äº†ï¼šåŸæœ‰æŒ‘æˆ° + é™·é˜±ç‰¹è¨“ã€‚<br/>
                                    Jeremyï¼Œä»Šæ¬¡ä¸€å®šç„¡æ•µï¼
                                </p>
                                <button onClick={startQuiz} className="w-full rounded-[2rem] bg-indigo-600 py-6 text-3xl font-black text-white shadow-2xl hover:bg-indigo-700 transition-all active:scale-95">
                                    é–‹å§‹æœæŸ¥
                                </button>
                            </div>
                        )}

                        {currentStep === 'quiz' && currentQuestion && (
                            <div className="space-y-6">
                                <div className="rounded-[3rem] bg-white p-10 shadow-sm border border-slate-200 animate-in fade-in duration-500">
                                    <div className="mb-6 flex justify-between items-center">
                                        <span className="px-5 py-2 bg-indigo-50 text-indigo-600 rounded-full text-xs font-black uppercase tracking-widest">{currentQuestion.type}</span>
                                        {currentQuestion.correctFirst && (
                                            <div className="flex gap-2">
                                                <div className={`w-4 h-4 rounded-full border-2 ${subStep === 'first' ? 'bg-indigo-600 animate-pulse border-indigo-200' : 'bg-green-500 border-green-200'}`}></div>
                                                <div className={`w-4 h-4 rounded-full border-2 ${subStep === 'second' ? 'bg-indigo-600 animate-pulse border-indigo-200' : 'bg-slate-100 border-slate-200'}`}></div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <h3 className="mb-8 text-2xl font-black text-slate-900 leading-snug">{currentQuestion.text}</h3>

                                    {/* --- é¡¯ç¤ºé‚è¼¯å€åŸŸ --- */}
                                    {currentQuestion.type === QUESTION_TYPES.VERTICAL_FILL && (
                                        <VerticalDisplay data={currentQuestion.vertical} subStep={subStep} selectedAnswer={selectedAnswer} />
                                    )}
                                    
                                    {currentQuestion.type === QUESTION_TYPES.TIME_APP && (
                                        <div className="flex flex-col items-center bg-slate-50 p-6 rounded-[2rem] border border-slate-100 mb-8">
                                            <div className="flex items-center gap-4 text-indigo-600 font-black mb-4 text-lg text-balance text-center">
                                                <Icon.Clock size={24} /> ä¸Šåˆ {currentQuestion.startH}:00 <Icon.MoveRight /> {currentQuestion.duration} å°æ™‚å¾Œ
                                            </div>
                                            <ClockFace h={currentQuestion.busH} m={currentQuestion.busM} color="#dc2626" />
                                            <span className="text-xs font-black text-red-500 mt-2 tracking-widest uppercase">â†‘ å·´å£«ç­æ¬¡æ™‚é–“ â†‘</span>
                                        </div>
                                    )}

                                    {currentQuestion.type === QUESTION_TYPES.TIME_DRAW && (
                                        <div className="flex flex-col items-center">
                                            <ClockFace h={drawHour} m={drawMinute} color="#6366f1" />
                                            <div className="flex gap-4 mb-8">
                                                <button onClick={() => setDrawHour(h => h === 12 ? 1 : h + 1)} className="bg-slate-800 text-white px-6 py-3 rounded-2xl font-black shadow-lg hover:bg-slate-700 transition-all">+1 å°æ™‚</button>
                                                <button onClick={() => setDrawMinute(m => (m === 0 ? 30 : 0))} className="bg-slate-800 text-white px-6 py-3 rounded-2xl font-black shadow-lg hover:bg-slate-700 transition-all">+30 åˆ†é˜</button>
                                            </div>
                                        </div>
                                    )}

                                    {currentQuestion.type === QUESTION_TYPES.TIME_FUZZY && (
                                        <div className="flex flex-col items-center mb-8">
                                            <ClockFace h={currentQuestion.fuzzyTime.h} m={currentQuestion.fuzzyTime.m} color="#6366f1" />
                                        </div>
                                    )}

                                    {/* --- æŒ‰éˆ•å€åŸŸ --- */}
                                    <div className="mt-8 space-y-8">
                                        {subStep === 'first' && currentQuestion.firstOptions ? (
                                            <div className="animate-in slide-in-from-left-6 duration-500">
                                                <p className="text-[10px] font-black text-slate-400 mb-5 uppercase tracking-[0.3em] text-center">ç¬¬ä¸€æ­¥ï¼šåˆ†æç·šç´¢</p>
                                                <div className="grid grid-cols-2 gap-6">
                                                    {currentQuestion.firstOptions.map((opt, i) => (
                                                        <button key={`f-opt-${i}`} onClick={() => handleAnswer(opt)} className={`p-8 text-3xl font-black rounded-[2rem] border-4 transition-all shadow-sm ${selectedAnswer === opt ? (opt === currentQuestion.correctFirst ? 'border-green-500 bg-green-50 text-green-600' : 'border-red-500 bg-red-50 text-red-600') : 'border-slate-100 bg-slate-50 hover:border-indigo-300'}`}>{opt}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="animate-in slide-in-from-right-6 duration-500">
                                                <p className="text-[10px] font-black text-slate-400 mb-5 uppercase tracking-[0.3em] text-center">æœ€å¾Œç­”æ¡ˆ</p>
                                                {currentQuestion.type === QUESTION_TYPES.TIME_DRAW ? (
                                                    <button onClick={() => handleAnswer('')} className="w-full bg-indigo-600 text-white py-6 rounded-[2rem] text-3xl font-black shadow-2xl hover:bg-indigo-700 active:scale-95 transition-all">ç¢ºèªæ’¥æ­£æŒ‡é‡</button>
                                                ) : (
                                                    <div className="grid grid-cols-2 gap-6">
                                                        {currentQuestion.secondOptions.map((opt, i) => (
                                                            <button key={`s-opt-${i}`} onClick={() => handleAnswer(opt)} disabled={selectedAnswer !== null} className={`p-6 text-xl font-black rounded-[2rem] border-4 transition-all shadow-sm ${selectedAnswer === opt ? (isCorrect ? 'border-green-500 bg-green-50 text-green-600' : 'border-red-500 bg-red-50 text-red-600') : (selectedAnswer !== null && opt.toString() === (currentQuestion.correctSecond || '').toString() ? 'border-green-300 bg-green-50' : 'border-slate-100 bg-slate-50 hover:border-indigo-300 active:scale-95')}`}>{opt}</button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {showRationale && (
                                    <div className={`rounded-[2.5rem] p-8 shadow-2xl border-l-[12px] animate-in slide-in-from-bottom-8 duration-500 ${isCorrect ? 'bg-green-50 border-green-500' : 'bg-rose-50 border-rose-500'}`}>
                                        <div className="flex gap-6">
                                            <div className={`p-5 rounded-3xl shrink-0 h-fit ${isCorrect ? 'bg-green-100 text-green-600' : 'bg-rose-100 text-rose-600'}`}>
                                                {isCorrect ? <Icon.CheckCircle2 size={48} /> : <Icon.AlertCircle size={48} />}
                                            </div>
                                            <div className="flex-1">
                                                <h4 className="font-black text-2xl mb-3 text-slate-800">{isCorrect ? 'ç ´è§£æˆåŠŸï¼' : 'åµæ¢ç­†è¨˜ï¼š'}</h4>
                                                <div className="text-slate-700 font-bold space-y-2 text-xl leading-relaxed">
                                                    {currentQuestion.type === QUESTION_TYPES.COMPARISON && !tempIsFirstCorrect && <p className="text-rose-600 underline decoration-2">âŒ é‚è¼¯é¸éŒ¯äº†ï¼š{currentQuestion.explanationFirst}</p>}
                                                    <p>{currentQuestion.explanationSecond}</p>
                                                </div>
                                                <button onClick={nextQuestion} className="mt-8 w-full flex items-center justify-center gap-3 rounded-2xl bg-slate-900 py-6 text-white font-black text-2xl hover:bg-slate-800 transition-all active:scale-95 shadow-xl">
                                                    {questionCount >= TOTAL_QUESTIONS - 1 ? 'æœ€çµ‚å ±å‘Š' : 'ä¸‹ä¸€å€‹æ¡ˆä»¶'} <Icon.ChevronRight size={32} />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {currentStep === 'feedback' && (
                            <div className="rounded-[3.5rem] bg-white p-12 text-center shadow-2xl animate-in zoom-in-95 duration-500 border border-slate-100">
                                <h2 className="text-5xl font-black mb-10 tracking-tight text-slate-800">æœ€çµ‚æœæŸ¥å ±å‘Š</h2>
                                <div className="flex justify-center gap-8 mb-12">
                                    <div className="bg-slate-50 p-8 rounded-[2rem] min-w-[150px] border border-slate-100">
                                        <div className="text-sm font-black text-slate-400 mb-2 uppercase tracking-widest">ç¸½è€—æ™‚</div>
                                        <div className="text-5xl font-black text-slate-800">{totalTime}ç§’</div>
                                    </div>
                                    <div className="bg-indigo-600 p-8 rounded-[2rem] min-w-[150px] text-white shadow-xl shadow-indigo-100">
                                        <div className="text-sm font-black opacity-70 mb-2 uppercase tracking-widest">æœ€çµ‚å¾—åˆ†</div>
                                        <div className="text-6xl font-black">{Math.round((score / TOTAL_QUESTIONS) * 100)}</div>
                                    </div>
                                </div>
                                <div className="text-left space-y-6 max-h-[450px] overflow-y-auto pr-4 custom-scrollbar">
                                    <h3 className="font-black text-3xl text-slate-800 mb-6 underline decoration-indigo-200 underline-offset-8">æ¡ˆä»¶å›é¡§ï¼š</h3>
                                    {history.filter(h => !h.isOk).length === 0 ? (
                                        <div className="py-16 px-10 bg-green-50 rounded-[3rem] text-green-700 font-black text-center border-4 border-dashed border-green-200">ğŸ† å®Œç¾çš„ç¦çˆ¾æ‘©æ–¯ï¼Jeremy ç°¡ç›´æ˜¯æ•¸å­¸å¤©æ‰ï¼</div>
                                    ) : (
                                        history.filter(h => !h.isOk).map((err, i) => (
                                            <div key={`err-log-${i}`} className="bg-rose-50/50 p-8 rounded-[2.5rem] border-2 border-rose-100 mb-6">
                                                <div className="text-xs font-black text-rose-400 uppercase mb-3 bg-rose-100 w-fit px-4 py-1 rounded-full">{err.type}</div>
                                                <p className="text-xl font-black text-slate-800 mb-4 leading-tight">{err.text}</p>
                                                <div className="text-lg font-bold text-slate-600 italic bg-white/80 p-5 rounded-3xl border border-rose-50">
                                                    ğŸ’¡ æç¤ºï¼š{err.explanationSecond}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <button onClick={() => { setCurrentStep('menu'); }} className="mt-12 w-full rounded-[2.5rem] bg-indigo-600 py-8 text-3xl font-black text-white shadow-2xl flex items-center justify-center gap-5 hover:bg-indigo-700 transition-all active:scale-95">
                                    <Icon.RefreshCcw size={40} /> é‡æ–°æŒ‘æˆ°
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
