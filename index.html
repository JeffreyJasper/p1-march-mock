<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jeremy Êï∏Â≠∏ÂÅµÊé¢ V5.6</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        button { touch-action: manipulation; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // --- ÂúñÊ®ôÁµÑ‰ª∂ ---
        const Icon = {
            Search: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trophy: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Bike: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18.5" cy="17.5" r="3.5"/><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="15" cy="5" r="1"/><path d="M7 17.5 9.5 8.5H15l1.5 5H21"/><path d="M12 13.5h2.5l2 4.5"/><path d="M5.5 14h1.5"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
            Alert: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Next: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Refresh: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><polyline points="21 3 21 8 16 8"/></svg>,
            Copy: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            ClipboardCheck: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>,
            Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        const QUESTION_TYPES = {
            POSITION_GRID: 'È£üÁâ©Ê´ÉÁõ∏Â∞ç‰ΩçÁΩÆ',
            POSITION_CAR: 'ËªäÂ≠êÊéíÂàóÂâçÂæå',
            DISTANCE_BIKE: 'ÂñÆËªäÊØîË≥ΩË∑ùÈõ¢',
            MEASURE_UNIT: 'ÈáèÂ∫¶ÂñÆ‰ΩçÈÅ∏Êìá',
            MEASURE_COUNT: 'Ëá™Ë®ÇÂñÆ‰ΩçÈáèÂ∫¶',
            VERTICAL: 'Áõ¥ÂºèÂ°´Á©∫',
            WORD_PROBLEM: 'ÊñáÂ≠óÊáâÁî®È°å',
            TIME: 'ÊôÇÈñìÊáâÁî®È°å'
        };

        const FOODS = ['üçé', 'üç©', 'üçû', 'üßÄ', 'üçå', 'üçï', 'üßÅ', 'üç¶'];
        const VEHICLES = [
            { name: 'Á¥ÖËªä', color: 'bg-red-500' },
            { name: 'Á¥´Ëªä', color: 'bg-purple-500' },
            { name: 'Á∂†Ëªä', color: 'bg-green-500' },
            { name: 'ÁÅ∞Ëªä', color: 'bg-gray-500' }
        ];

        // --- Â≠êÁµÑ‰ª∂ÔºöÊôÇÈêò ---
        const ClockFace = ({ h, m, color = "#1e293b", size = 180 }) => {
            const hourAngle = (h * 30) + (m * 0.5);
            const minuteAngle = m * 6;
            return (
                <div className="flex justify-center my-4">
                    <svg width={size} height={size} viewBox="0 0 200 200" className="drop-shadow-xl">
                        <circle cx="100" cy="100" r="95" fill="white" stroke={color} strokeWidth="5" />
                        {[...Array(12)].map((_, i) => (
                            <text key={i} x={100 + 72 * Math.sin((i+1)*Math.PI/6)} y={105 - 72 * Math.cos((i+1)*Math.PI/6)} textAnchor="middle" className="font-black text-xl" fill={color}>{i+1}</text>
                        ))}
                        <line x1="100" y1="100" x2={100 + 40 * Math.sin(hourAngle * Math.PI / 180)} y2={100 - 40 * Math.cos(hourAngle * Math.PI / 180)} stroke={color} strokeWidth="10" strokeLinecap="round" />
                        <line x1="100" y1="100" x2={100 + 70 * Math.sin(minuteAngle * Math.PI / 180)} y2={100 - 70 * Math.cos(minuteAngle * Math.PI / 180)} stroke="#ef4444" strokeWidth="6" strokeLinecap="round" />
                        <circle cx="100" cy="100" r="7" fill={color} />
                    </svg>
                </div>
            );
        };

        // --- Â≠êÁµÑ‰ª∂ÔºöÁõ¥ÂºèÂ°´Á©∫ ---
        const VerticalDisplay = ({ data, subStep, selectedAnswer }) => (
            <div className="flex justify-center my-8 font-mono scale-110">
                <div className="grid grid-cols-[3rem_4rem_4rem] items-center text-5xl leading-none text-slate-700">
                    <div className="col-start-1"></div>
                    <div className="col-start-2 text-center">{data.t1}</div>
                    <div className={`col-start-3 text-center border-2 border-dashed rounded-xl h-20 flex items-center justify-center transition-all ${subStep === 'first' && !selectedAnswer ? 'border-amber-400 bg-amber-50 animate-pulse text-amber-600' : 'border-slate-200 bg-white text-slate-700'}`}>
                        {subStep === 'first' && !selectedAnswer ? 'a' : data.o1}
                    </div>
                    <div className="col-start-1 text-center text-slate-400 font-bold">{data.symbol}</div>
                    <div className={`col-start-2 text-center border-2 border-dashed rounded-xl h-20 flex items-center justify-center transition-all ${subStep === 'second' && !selectedAnswer ? 'border-indigo-400 bg-indigo-50 animate-pulse text-indigo-600' : (subStep === 'first' ? 'border-slate-100 bg-slate-50 text-transparent' : 'border-slate-200 bg-white text-slate-700')}`}>
                        {subStep === 'second' && !selectedAnswer ? 'b' : (subStep === 'first' ? '?' : data.t2)}
                    </div>
                    <div className="col-start-3 text-center">{data.o2}</div>
                    <div className="col-span-3 border-b-8 border-slate-800 my-6 rounded-full"></div>
                    <div className="col-start-1"></div>
                    <div className="col-start-2 text-center font-black">{Math.floor(data.result / 10)}</div>
                    <div className="col-start-3 text-center font-black">{data.result % 10}</div>
                </div>
            </div>
        );

        const App = () => {
            const [stage, setStage] = useState('menu');
            const [score, setScore] = useState(0);
            const [startTime, setStartTime] = useState(0);
            const [endTime, setEndTime] = useState(0);
            const [questionCount, setQuestionCount] = useState(0);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [multiSelected, setMultiSelected] = useState([]);
            const [isCorrect, setIsCorrect] = useState(null);
            const [showRationale, setShowRationale] = useState(false);
            const [subStep, setSubStep] = useState('first'); 
            const [history, setHistory] = useState([]);
            const [copyStatus, setCopyStatus] = useState(false);

            const [drawHour, setDrawHour] = useState(12);
            const [drawMinute, setDrawMinute] = useState(0);

            const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);

            // --- Ê†∏ÂøÉÔºöÁîüÊàêÈ°åÁõÆ ---
            const generateQuizSet = () => {
                let questions = [];

                // 1-3. ‰ΩçÁΩÆ (Grid)
                const grid1 = shuffle([...FOODS]);
                const gridA = [grid1.slice(0,4), grid1.slice(4,8)];
                const rA = 0, cA = 1; 
                questions.push({
                    type: QUESTION_TYPES.POSITION_GRID,
                    text: `ÁúãÁúã‰∏ãÂúñÈ£üÁâ©Ê´ÉÔºö${gridA[rA][cA]} Âú® ${gridA[rA][cA-1]} ÁöÑÂì™‰∏ÄÈù¢Ôºü`,
                    visual: { type: 'grid', data: gridA },
                    options: ['Â∑¶Èù¢', 'Âè≥Èù¢', '‰∏äÈù¢', '‰∏ãÈù¢'],
                    correct: 'Âè≥Èù¢'
                });

                // 4. ËªäÈöä (Â§öÈÅ∏)
                const cars = shuffle([...CAR_COLORS]);
                const targetCar = cars[1];
                const answerCars = cars.slice(2).map(c => c.name);
                questions.push({
                    type: QUESTION_TYPES.POSITION_CAR,
                    text: `Â§öÈÅ∏È°åÔºö${targetCar.name} ÁöÑÂæåÈù¢ÊúâÂì™‰∫õËªäÔºü(Ë´ãÈªûÈÅ∏)`,
                    visual: { type: 'cars', data: cars },
                    isMulti: true,
                    options: cars.map(c => c.name),
                    correct: answerCars
                });
                
                // 5. Ë∑ùÈõ¢ÔºöÂñÆËªäÊØîË≥Ω (ÊúÄÈÅ†)
                const bike1 = shuffle([{n:'ÂèØÊô¥', d:80}, {n:'ÊüèÂ∫∑', d:30}, {n:'Ë±™Â∫≠', d:60}]);
                questions.push({
                    type: QUESTION_TYPES.DISTANCE_BIKE,
                    text: "ÁúãÂúñ‰∏≠ÁöÑÂñÆËªäÊØîË≥ΩÔºåË™∞Ë∑ùÈõ¢„ÄåËµ∑Èªû„ÄçÊúÄÈÅ†Ôºü",
                    visual: { type: 'bike', data: bike1 },
                    options: bike1.map(b => b.n),
                    correct: bike1.reduce((prev, current) => (prev.d > current.d) ? prev : current).n
                });

                // 6. ÈáèÂ∫¶ÔºöÂñÆ‰ΩçÈÅ∏Êìá
                const items = [{n:'Ê§ÖÂ≠ê', a:'ÈûãÂ≠ê', i:'ü™ë'}, {n:'Êì¶ËÜ†', a:'Ëê¨Â≠óÂ§æ', i:'‚úèÔ∏è'}];
                const itemQ = items[Math.floor(Math.random() * items.length)];
                questions.push({
                    type: QUESTION_TYPES.MEASURE_UNIT,
                    text: `ÈáèÂ∫¶„Äå${itemQ.n}„ÄçÁöÑÈï∑Â∫¶ÔºåÁî®‰ªÄÈ∫ºÂ∑•ÂÖ∑ÊúÄÂêàÈÅ©Ôºü`,
                    visual: { type: 'unit', icon: itemQ.i },
                    options: ['Ëê¨Â≠óÂ§æ', 'ÈûãÂ≠ê', 'Èï∑Â∞∫'],
                    correct: itemQ.a
                });

                // 7. ÈáèÂ∫¶ÔºöÊï∏Ëê¨Â≠óÂ§æ
                const count = Math.floor(Math.random() * 3) + 4;
                questions.push({
                    type: QUESTION_TYPES.MEASURE_COUNT,
                    text: "Âúñ‰∏≠ÁöÑÁ≠ÜË¢ãÂ§ßÁ¥ÑÈï∑Â§öÂ∞ëÂÄã„ÄåËê¨Â≠óÂ§æ„ÄçÔºü",
                    visual: { type: 'count', count: count },
                    options: [(count-1).toString(), count.toString(), (count+1).toString()],
                    correct: count.toString()
                });

                // 8. Êí•ÊôÇÈêò
                const h1 = Math.floor(Math.random() * 12) + 1;
                questions.push({
                    type: QUESTION_TYPES.TIME,
                    text: `Ë´ãÊí•ÂãïÊåáÈáùÔºåÁï´Âá∫„Äå${h1} ÊôÇÂçä„Äç„ÄÇ`,
                    visual: { type: 'draw' },
                    targetH: h1, targetM: 30,
                    options: [],
                    correct: 'draw'
                });

                // 9. ÊôÇÈñìÊáâÁî®ÔºöË∂ïÂ∑¥Â£´
                const startH = 8;
                const dur = 4;
                const busH = 12; // 12Èªû
                questions.push({
                    type: QUESTION_TYPES.TIME,
                    text: `Â∞èÊòé‰∏äÂçà ${startH} ÊôÇ‰∏äÂ≠∏Ôºå${dur} Â∞èÊôÇÂæåÊîæÂ≠∏„ÄÇË´ãÂïè‰ªñËÉΩÂê¶Ë∂ï‰∏äÈÄôÁè≠Â∑¥Â£´Ôºü`,
                    visual: { type: 'bus_check', h: busH },
                    options: ['ËÉΩ', '‰∏çËÉΩ'],
                    correct: 'ËÉΩ'
                });

                // 10. Áõ¥ÂºèÂ°´Á©∫
                const v1_o1 = 7, v1_t2 = 1;
                questions.push({
                    type: QUESTION_TYPES.VERTICAL,
                    text: `ÊâæÂá∫Áõ¥ÂºèË¨éÈ°å‰∏≠ÁöÑ [a] Âíå [b]„ÄÇ`,
                    vertical: { t1: 2, o1: v1_o1, t2: v1_t2, o2: 5, result: 42, symbol: '+' },
                    correctFirst: v1_o1.toString(),
                    correctSecond: v1_t2.toString(),
                    firstOptions: shuffle([v1_o1.toString(), '3', '5', '8']),
                    secondOptions: shuffle([v1_t2.toString(), '2', '4', '6']),
                    explanationSecond: `Ê≠£Á¢∫Áõ¥ÂºèÔºö27 + 15 = 42`
                });

                // 11. ÊñáÂ≠óÊáâÁî®È°å (ÊØîËºÉÈÇèËºØ - ÊâæÂ§ß)
                const valA = 16, diffA = 8;
                questions.push({
                    type: QUESTION_TYPES.WORD_PROBLEM,
                    text: `Â≠êË®ÄÊúâËòãÊûú ${valA} ÂÄãÔºåÂ∞èÁé≤ÊØîÂ≠êË®ÄÂ§ö ${diffA} ÂÄã„ÄÇË´ãÂïèÂ∞èÁé≤ÊúâÂ§öÂ∞ëÂÄãËòãÊûúÔºü`,
                    correctFirst: `${valA} + ${diffA}`,
                    correctSecond: (valA + diffA).toString(),
                    firstOptions: [`${valA} + ${diffA}`, `${valA} - ${diffA}`],
                    secondOptions: shuffle([(valA+diffA).toString(), (valA-diffA).toString(), (valA+diffA+2).toString(), (valA+diffA-5).toString()]),
                    explanationFirst: "Â∞èÁé≤ÊØîÂ≠êË®ÄÂ§öÔºåÊâÄ‰ª•Â∞èÁé≤ÊòØÂ§ßÂì•Âì•ÔºåÁî®Âä†Ê≥ï„ÄÇ",
                    explanationSecond: `ÁÆóÂºèÔºö${valA} + ${diffA} = ${valA + diffA}`
                });

                 // 12. ÊñáÂ≠óÊáâÁî®È°å (ÈÄÜÂêëÈÇèËºØ)
                const valC = 18, diffC = 4;
                questions.push({
                    type: QUESTION_TYPES.WORD_PROBLEM,
                    text: `Â∞èÊòéÊúâËªäÂ≠ê ${valC} ËºõÔºåÂ∞èÊòéÊØîÂ∞èËèØÂ§ö ${diffC} Ëºõ„ÄÇË´ãÂïèÂ∞èËèØÊúâÂ§öÂ∞ëËºõËªäÔºü`,
                    correctFirst: `${valC} - ${diffC}`,
                    correctSecond: (valC - diffC).toString(),
                    firstOptions: [`${valC} + ${diffC}`, `${valC} - ${diffC}`],
                    secondOptions: shuffle([(valC-diffC).toString(), (valC+diffC).toString(), (valC-diffC+2).toString(), (valC-diffC-3).toString()]),
                    explanationFirst: "Â∞èÊòéÊØîÂ∞èËèØÂ§öÔºåÂç≥‰øÇÂ∞èËèØÊØîËºÉÂ∞ëÔºåË¶ÅÁî®Ê∏õÊ≥ï„ÄÇ",
                    explanationSecond: `ÁÆóÂºèÔºö${valC} - ${diffC} = ${valC - diffC}`
                });

                return shuffle(questions);
            };

            const startGame = () => {
                setQuizSet(generateQuizSet());
                setScore(0);
                setCurrentQuestionIndex(0);
                setStage('quiz');
                setDrawHour(12); setDrawMinute(0);
                setMultiSelected([]);
                setSubStep('first');
                setHistory([]);
                setStartTime(Date.now());
            };

            const handleAnswer = (ans) => {
                const q = quizSet[currentQIndex];
                
                // Áõ¥Âºè Êàñ ÊñáÂ≠óÈ°å (ÂÖ©Ê≠•)
                if (q.type === QUESTION_TYPES.VERTICAL || q.type === QUESTION_TYPES.WORD_PROBLEM) {
                    if (subStep === 'first') {
                        const ok = ans === q.correctFirst;
                        setSelectedAnswer(ans);
                        if (ok) setTimeout(() => { setSubStep('second'); setSelectedAnswer(null); }, 600);
                        else finish(ans, false);
                    } else {
                        finish(ans, ans === q.correctSecond);
                    }
                    return;
                }

                // Â§öÈÅ∏
                if (q.isMulti) {
                    if (ans === 'confirm') {
                        const correctSet = q.correct.sort().join(',');
                        const userSet = multiSelected.sort().join(',');
                        finish(userSet === correctSet, true); 
                    } else {
                        setMultiSelected(prev => prev.includes(ans) ? prev.filter(x=>x!==ans) : [...prev, ans]);
                    }
                    return;
                }

                // Êí•ÊôÇÈêò
                if (q.visual?.type === 'draw' && ans === 'confirm') {
                    const isOk = drawHour === q.targetH && drawMinute === q.targetM;
                    finish(isOk, true);
                    return;
                }

                // ÂñÆÈÅ∏
                if (ans !== 'confirm') {
                    finish(ans === q.correct, true);
                }
            };

            const finish = (ans, isOkValue) => {
                let finalOk = typeof ans === 'boolean' ? ans : isOkValue;
                if (typeof ans !== 'boolean') {
                     setSelectedAnswer(ans);
                }
                
                setIsCorrect(finalOk);
                if (finalOk) setScore(s => s + 1);
                
                // Âä†ÂÖ•Ê≠∑Âè≤Á¥ÄÈåÑ
                setHistory(prev => [...prev, {
                    ...quizSet[currentQIndex],
                    userAnswer: typeof ans === 'boolean' ? (finalOk ? 'Ê≠£Á¢∫' : 'ÈåØË™§') : ans,
                    isCorrect: finalOk
                }]);

                setShowRationale(true);
            };

            const nextQ = () => {
                if (currentQIndex >= quizSet.length - 1) {
                    setEndTime(Date.now());
                    setStage('result');
                } else {
                    setCurrentQuestionIndex(p => p + 1);
                    setSelectedAnswer(null);
                    setShowRationale(false);
                    setIsCorrect(null);
                    setMultiSelected([]);
                    setDrawHour(12); setDrawMinute(0);
                    setSubStep('first');
                }
            };

            // Ë§áË£ΩÂ†±ÂëäÂäüËÉΩ
            const copyReport = () => {
                const totalSeconds = Math.floor((endTime - startTime) / 1000);
                const scorePercent = Math.round((score / quizSet.length) * 100);
                const date = new Date().toLocaleString();
                
                let report = `„ÄêJeremy Êï∏Â≠∏ÂÅµÊé¢Â†±Âëä„Äë\n`;
                report += `Êó•ÊúüÔºö${date}\n`;
                report += `Á∏ΩÁî®ÊôÇÔºö${totalSeconds}Áßí\n`;
                report += `ÂæóÂàÜÔºö${scorePercent}ÂàÜ (${score}/${quizSet.length})\n\n`;

                const mistakes = history.filter(h => !h.isCorrect);
                if (mistakes.length === 0) {
                    report += "üèÜ ÂÆåÁæéÔºÅÂÖ®Â∞çÔºÅJeremy ÊòØÊúÄÂº∑ÂÅµÊé¢ÔºÅ\n";
                } else {
                    report += "‚ö†Ô∏è ÈåØÈ°åÁ¥ÄÈåÑÔºö\n";
                    mistakes.forEach((m, i) => {
                        let correctAns = m.correct;
                        if(m.type === QUESTION_TYPES.VERTICAL || m.type === QUESTION_TYPES.WORD_PROBLEM) {
                             correctAns = `${m.correctFirst} -> ${m.correctSecond}`;
                        } else if (Array.isArray(m.correct)) {
                             correctAns = m.correct.join(',');
                        } else if (m.visual?.type === 'draw') {
                             correctAns = `${m.targetH}:${m.targetM === 0 ? '00' : '30'}`;
                        }
                        report += `${i + 1}. [${m.type}] ${m.text}\n   ‰Ω†ÁöÑÁ≠îÊ°àÔºö${m.userAnswer}\n   Ê≠£Á¢∫Á≠îÊ°àÔºö${correctAns}\n\n`;
                    });
                }

                const textArea = document.createElement("textarea");
                textArea.value = report;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopyStatus(true);
                    setTimeout(() => setCopyStatus(false), 2000);
                } catch (err) {
                    console.error('Copy failed', err);
                }
                document.body.removeChild(textArea);
            };

            // Ë¶ñË¶∫Ê∏≤ÊüìÁµÑ‰ª∂
            const VisualArea = ({ q }) => {
                const { type, data } = q.visual || {};
                
                if (type === 'grid') return (
                    <div className="grid grid-cols-4 gap-2 bg-amber-50 p-4 rounded-2xl border-4 border-amber-200">
                        {data.flat().map((v, i) => <div key={i} className="aspect-square bg-white rounded-xl flex items-center justify-center text-4xl shadow-sm">{v}</div>)}
                    </div>
                );
                if (type === 'cars') return (
                    <div className="relative pt-8 pb-2">
                        <div className="flex justify-between px-4 mb-2 text-slate-500 font-black text-xs">
                            <span className="flex items-center gap-1">‚¨ÖÔ∏è ËªäÈ†≠ (Ââç)</span>
                            <span className="flex items-center gap-1">ËªäÂ∞æ (Âæå) ‚û°Ô∏è</span>
                        </div>
                        <div className="flex items-center gap-4 bg-slate-100 p-6 rounded-2xl overflow-x-auto border-2 border-slate-200">
                            {data.map((car, i) => (
                                <button key={i} onClick={() => !showRationale && q.isMulti && handleAnswer(car.name)} 
                                    className={`shrink-0 w-16 h-10 ${car.color} rounded-t-xl rounded-b-md relative shadow-md transition-all 
                                    ${multiSelected.includes(car.name) ? 'ring-4 ring-indigo-500 scale-110' : ''}`}>
                                    <div className="absolute top-1 left-2 w-10 h-4 bg-white/30 rounded"></div>
                                    <div className="absolute -bottom-6 left-0 right-0 text-xs font-bold text-slate-600 text-center">{car.name}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
                if (type === 'bike') return (
                    <div className="relative h-48 bg-white rounded-2xl border-2 border-dashed border-slate-300 p-4 overflow-hidden">
                        <div className="absolute left-6 top-0 bottom-0 w-1 bg-green-500 z-10"></div>
                        <div className="absolute left-2 top-2 text-xs font-black text-green-600 bg-white px-1">üö© Ëµ∑Èªû</div>
                        <div className="absolute right-2 top-2 text-xs font-black text-red-600 bg-white px-1">üèÅ ÁµÇÈªû</div>
                        {data.map((p, i) => (
                            <div key={i} className="absolute flex flex-col items-center transition-all" style={{ left: `${p.d}%`, top: `${20 + i * 25}%` }}>
                                <Icon.Bike />
                                <span className="text-xs font-black bg-slate-100 px-2 rounded-full shadow-sm mt-1 whitespace-nowrap">{p.n}</span>
                            </div>
                        ))}
                    </div>
                );
                if (type === 'lines') return (
                    <div className="space-y-6 p-6 bg-white rounded-2xl border">
                        {data.map((l, i) => (
                            <div key={i} className="flex items-center gap-2">
                                <span className="text-xs font-bold w-12">{l.n}</span>
                                <div className={`h-4 ${l.c} rounded-full shadow-sm`} style={{ width: `${l.w}%` }}></div>
                            </div>
                        ))}
                    </div>
                );
                if (type === 'unit') return <div className="text-8xl p-10 bg-indigo-50 rounded-3xl flex justify-center shadow-inner">{q.visual.icon}</div>;
                if (type === 'count') return (
                    <div className="flex flex-col items-center gap-4 p-6 bg-white rounded-2xl border">
                        <div className="w-full h-12 bg-blue-100 rounded-lg flex items-center px-4 border-2 border-blue-200">
                             <div className="w-full h-2 bg-blue-400 rounded-full"></div>
                        </div>
                        <div className="flex gap-1">
                            {[...Array(q.visual.count)].map((_, i) => (
                                <div key={i} className="w-8 h-4 border-2 border-slate-400 rounded-full flex items-center justify-center opacity-70 bg-slate-200"></div>
                            ))}
                        </div>
                        <p className="text-sm text-slate-400">‚Üë Ëê¨Â≠óÂ§æ ‚Üë</p>
                    </div>
                );
                if (type === 'draw') return (
                    <div className="flex flex-col items-center">
                        <ClockFace h={drawHour} m={drawMinute} color="#6366f1" />
                        <div className="flex gap-4">
                            <button onClick={() => setDrawHour(h => h===12?1:h+1)} className="bg-slate-800 text-white px-6 py-3 rounded-2xl font-black">+1 Â∞èÊôÇ</button>
                            <button onClick={() => setDrawMinute(m => m===0?30:0)} className="bg-slate-800 text-white px-6 py-3 rounded-2xl font-black">+30 ÂàÜÈêò</button>
                        </div>
                    </div>
                );
                if (type === 'clock_add') return (
                    <div className="flex items-center justify-center gap-4 text-2xl font-black text-indigo-700 bg-indigo-50 p-6 rounded-3xl">
                        <ClockFace h={q.visual.h} m={0} size={80} />
                        <Icon.ArrowRight />
                        <div className="text-center">
                            <div className="text-sm text-slate-400">Á∂ìÈÅé</div>
                            <div>{q.visual.add} Â∞èÊôÇ</div>
                        </div>
                        <Icon.ArrowRight />
                        <div className="w-20 h-20 border-4 border-dashed border-indigo-300 rounded-full flex items-center justify-center text-indigo-300">?</div>
                    </div>
                );
                if (type === 'bus_check') return (
                    <div className="flex flex-col items-center">
                        <ClockFace h={q.visual.h} m={0} color="#dc2626" />
                        <div className="bg-red-100 text-red-600 px-4 py-1 rounded-full text-xs font-bold mt-2">Â∑¥Â£´ÈñãÂá∫ÊôÇÈñì</div>
                    </div>
                );
                return null;
            };

            const q = quizSet[currentQIndex];

            return (
                <div className="min-h-screen p-4 flex flex-col items-center">
                    {stage === 'menu' && (
                        <div className="w-full max-w-xl bg-white p-12 rounded-[3rem] shadow-xl text-center border-t-8 border-indigo-600 mt-10">
                            <Icon.Trophy className="text-amber-400 mx-auto mb-6 animate-bounce w-24 h-24" />
                            <h2 className="text-3xl font-black mb-4 text-slate-800">ÂÖ®Êñπ‰ΩçÊï∏Â≠∏Â§ßÂÜíÈö™</h2>
                            <p className="text-slate-500 font-bold mb-10 leading-relaxed">
                                V5.6 Â†±ÂëäÂº∑ÂåñÁâà<br/>ÊñáÂ≠óÊáâÁî®È°å„ÄÅÁõ¥ÂºèÂ°´Á©∫„ÄÅÂñÆËªäË≥ΩË∑ëÔºÅ
                            </p>
                            <button onClick={startGame} className="w-full bg-indigo-600 text-white py-6 rounded-3xl text-2xl font-black shadow-xl active:scale-95 transition-all">ÈñãÂßãÊåëÊà∞</button>
                        </div>
                    )}

                    {stage === 'quiz' && q && (
                        <div className="w-full max-w-xl space-y-6">
                            <header className="flex justify-between items-center bg-white p-4 rounded-3xl shadow-sm">
                                <div className="font-black text-slate-400 uppercase tracking-widest text-sm">Question</div>
                                <div className="bg-indigo-600 text-white px-4 py-1 rounded-full font-black text-lg">{currentQIndex + 1} / {quizSet.length}</div>
                            </header>

                            <div className="bg-white p-8 rounded-[3rem] shadow-md border border-slate-200">
                                <span className="px-4 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-black mb-6 inline-block uppercase tracking-widest">{q.type}</span>
                                <h3 className="text-2xl font-bold mb-8 text-slate-800 leading-snug">{q.text}</h3>
                                
                                {q.type === QUESTION_TYPES.VERTICAL && <VerticalDisplay data={q.vertical} subStep={subStep} selectedAnswer={selectedAnswer} />}
                                {q.type !== QUESTION_TYPES.VERTICAL && <VisualArea q={q} />}

                                <div className="mt-10 grid grid-cols-1 gap-4">
                                    {q.isMulti || q.visual?.type === 'draw' ? (
                                        <button onClick={() => handleAnswer('confirm')} className="w-full bg-slate-900 text-white py-6 rounded-3xl text-xl font-black shadow-xl active:scale-95">Á¢∫Ë™çÁ≠îÊ°à</button>
                                    ) : (q.type === QUESTION_TYPES.VERTICAL || q.type === QUESTION_TYPES.WORD_PROBLEM) ? (
                                        <div className="animate-in slide-in-from-right-4">
                                            <p className="text-xs font-black text-slate-400 mb-4 uppercase tracking-[0.2em] text-center">
                                                {subStep === 'first' ? (q.type === QUESTION_TYPES.WORD_PROBLEM ? "Á¨¨‰∏ÄÊ≠•ÔºöÈÅ∏ÊìáÊ≠£Á¢∫ÂàóÂºè" : "Á¨¨‰∏ÄÊ≠•ÔºöÊâæÂá∫ÊñπÊ†º [a]") : "Á¨¨‰∫åÊ≠•ÔºöË®àÁÆóÁ≠îÊ°à"}
                                            </p>
                                            <div className="grid grid-cols-2 gap-6">
                                                {(subStep === 'first' ? q.firstOptions : q.secondOptions).map((opt, i) => (
                                                    <button key={i} onClick={() => handleAnswer(opt)} className={`p-6 text-xl font-black rounded-3xl border-4 transition-all ${selectedAnswer === opt ? (isCorrect === false ? 'border-red-500 bg-red-50' : 'border-green-500 bg-green-50') : 'border-slate-100 bg-slate-50 hover:border-indigo-300'}`}>
                                                        {opt}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        q.options.map((opt, i) => (
                                            <button key={i} onClick={() => handleAnswer(opt)} disabled={showRationale} className={`p-6 text-xl font-black rounded-3xl border-4 transition-all text-left ${showRationale && opt === q.correct ? 'border-green-500 bg-green-50' : 'border-slate-100 bg-slate-50 hover:border-indigo-300'}`}>
                                                {opt}
                                            </button>
                                        ))
                                    )}
                                </div>
                            </div>

                            {showRationale && (
                                <div className={`p-8 rounded-[2.5rem] shadow-2xl border-l-[12px] animate-in slide-in-from-bottom-8 duration-500 ${isCorrect ? 'bg-green-50 border-green-500' : 'bg-rose-50 border-rose-500'}`}>
                                    <div className="flex gap-4 items-center mb-4">
                                        {isCorrect ? <Icon.Check /> : <Icon.Alert />}
                                        <h4 className={`font-black text-2xl ${isCorrect ? 'text-green-800' : 'text-rose-800'}`}>{isCorrect ? 'Á≠îÂ∞ç‰∫ÜÔºÅ' : 'ÂÜçÊé•ÂÜçÂé≤ÔºÅ'}</h4>
                                    </div>
                                    <p className="text-lg font-bold mb-6 text-slate-600 italic">
                                        {q.explanationSecond || q.explanationFirst || `Ê≠£Á¢∫Á≠îÊ°àÊòØÔºö${Array.isArray(q.correct) ? q.correct.join('„ÄÅ') : q.correct}`}
                                    </p>
                                    <button onClick={nextQ} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl flex items-center justify-center gap-2 shadow-xl active:scale-95">‰∏ã‰∏ÄÈ°å <Icon.Next /></button>
                                </div>
                            )}
                        </div>
                    )}

                    {stage === 'result' && (
                        <div className="w-full max-w-xl bg-white p-12 rounded-[3.5rem] text-center shadow-2xl animate-in zoom-in-95 mt-10">
                            <Icon.Trophy className="text-amber-400 mx-auto mb-8 animate-bounce w-24 h-24" />
                            <h2 className="text-4xl font-black mb-4 text-slate-800">ÁâπË®ìÂÆåÊàêÔºÅ</h2>
                            <div className="flex justify-center gap-4 mb-8 text-slate-500 font-bold">
                                <span>ÊôÇÈñìÔºö{Math.floor((Date.now() - startTime) / 1000)}s</span>
                                <span>ÂæóÂàÜÔºö{Math.round((score / quizSet.length) * 100)}</span>
                            </div>
                            
                            <button 
                                onClick={copyReport} 
                                className={`w-full mb-6 py-6 rounded-3xl text-xl font-black flex items-center justify-center gap-3 transition-all ${copyStatus ? 'bg-green-600 text-white' : 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100'}`}
                            >
                                {copyStatus ? <><Icon.Check /> Â∑≤Ë§áË£ΩÂ†±Âëä</> : <><Icon.Copy /> Ë§áË£ΩÂÆåÊï¥Â†±Âëä</>}
                            </button>

                            <button onClick={() => setStage('menu')} className="w-full bg-slate-800 text-white py-6 rounded-3xl text-2xl font-black flex items-center justify-center gap-4 active:scale-95 transition-all shadow-xl">
                                <Icon.Refresh /> ÂÜç‰æÜ‰∏ÄÊ¨°
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
